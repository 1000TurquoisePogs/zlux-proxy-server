/*
 * This file was generated by the Gradle 'init' task.
 *
 */
apply plugin: 'java'

sourceSets {
  srcDirs
}

configurations {
  tomcatZip
  jars
}

repositories {
  mavenCentral()
}

dependencies {
  // https://mvnrepository.com/artifact/org.apache.tomcat/tomcat
  tomcatZip group: 'org.apache.tomcat', name: 'tomcat', version: '9.0.16', ext: 'zip'

  // https://mvnrepository.com/artifact/org.apache.httpcomponents/httpclient
  jars group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.7'

  // https://mvnrepository.com/artifact/org.apache.httpcomponents/httpcore
  jars group: 'org.apache.httpcomponents', name: 'httpcore', version: '4.4.11'

  // https://mvnrepository.com/artifact/javax.json/javax.json-api
  jars group: 'javax.json', name: 'javax.json-api', version: '1.1.4'
}

//this copies FROM... INTO... hopefully doesnt need a caching area in the from column?
task getDeps() {
  copy {
    from configurations.jars
    from configurations.tomcatZip
    into 'lib/java'
  }
  copy {
    from zipTree(file('lib/java/tomcat-9.0.16.zip'))
    into 'lib/java'
  }
  file('lib/java/apache-tomcat-9.0.16').renameTo(file('lib/java/apache-tomcat'))
  delete 'lib/java/tomcat-9.0.16.zip'

}

def testDir = 'test/lang-managers/java/src/HelloUserServlet'

task cleanTest(type: Delete) {
  delete fileTree(testDir + '/WEB-INF/classes')
  delete file(testDir + '/HelloUserServlet.war')
}

task buildJavaTest(type: JavaCompile, dependsOn: [':getDeps', ':cleanTest']) {
  classpath = files(configurations.jars, fileTree('lib/java/apache-tomcat'))
  source fileTree(testDir + '/src')
  destinationDir file(testDir + '/WEB-INF/classes')
}

task makeTestWar(type: Zip, dependsOn: ':buildJavaTest') {
  from testDir + '/WEB-INF'
  from testDir + '/META-INF'
  into file(testDir + '/HelloUserServlet.war')
}
